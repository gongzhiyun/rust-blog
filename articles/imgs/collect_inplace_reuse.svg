<?xml version="1.0" encoding="UTF-8"?>
<svg width="800" height="500" viewBox="0 0 800 500" xmlns="http://www.w3.org/2000/svg" shape-rendering="geometricPrecision" text-rendering="geometricPrecision">
    <!-- Background -->
    <rect width="800" height="500" fill="#f8f9fa" />
    
    <!-- Title -->
    <text x="400" y="30" font-family="JetBrains Mono, monospace" font-size="20" font-weight="bold" text-anchor="middle" fill="#333333">Collect 深度优化：就地重用 (In-place Reuse)</text>

    <!-- Stage 1: Original Vec -->
    <g transform="translate(50, 60)">
        <text x="0" y="-10" font-family="JetBrains Mono, monospace" font-size="14" font-weight="bold" fill="#2196f3">1. 原始 Vec (v1)</text>
        <rect width="180" height="80" rx="5" fill="#e3f2fd" stroke="#2196f3" stroke-width="2" />
        <text x="10" y="25" font-family="JetBrains Mono, monospace" font-size="12" fill="#333333">ptr: 0x1000</text>
        <text x="10" y="45" font-family="JetBrains Mono, monospace" font-size="12" fill="#333333">cap: 4, len: 4</text>
    </g>

    <!-- Heap: Buffer 0x1000 -->
    <g transform="translate(300, 60)">
        <text x="0" y="-10" font-family="JetBrains Mono, monospace" font-size="14" font-weight="bold" fill="#4caf50">Heap Buffer (0x1000)</text>
        <rect width="400" height="60" fill="#ffffff" stroke="#4caf50" stroke-width="2" />
        <rect x="0" y="0" width="100" height="60" fill="#e8f5e9" stroke="#4caf50" stroke-width="1" />
        <text x="50" y="35" font-family="JetBrains Mono, monospace" font-size="12" text-anchor="middle">T1</text>
        <rect x="100" y="0" width="100" height="60" fill="#e8f5e9" stroke="#4caf50" stroke-width="1" />
        <text x="150" y="35" font-family="JetBrains Mono, monospace" font-size="12" text-anchor="middle">T2</text>
        <rect x="200" y="0" width="100" height="60" fill="#e8f5e9" stroke="#4caf50" stroke-width="1" />
        <text x="250" y="35" font-family="JetBrains Mono, monospace" font-size="12" text-anchor="middle">T3</text>
        <rect x="300" y="0" width="100" height="60" fill="#e8f5e9" stroke="#4caf50" stroke-width="1" />
        <text x="350" y="35" font-family="JetBrains Mono, monospace" font-size="12" text-anchor="middle">T4</text>
    </g>

    <!-- Stage 2: Map Adapter -->
    <g transform="translate(50, 180)">
        <text x="0" y="-10" font-family="JetBrains Mono, monospace" font-size="14" font-weight="bold" fill="#9c27b0">2. v1.into_iter().map(f)</text>
        <rect width="220" height="100" rx="5" fill="#f3e5f5" stroke="#9c27b0" stroke-width="2" />
        <text x="10" y="25" font-family="JetBrains Mono, monospace" font-size="12" fill="#333333">In-place Adapter 检测:</text>
        <text x="10" y="45" font-family="JetBrains Mono, monospace" font-size="11" fill="#78909c">- Source: IntoIter</text>
        <text x="10" y="65" font-family="JetBrains Mono, monospace" font-size="11" fill="#78909c">- Target: same size/align</text>
        <text x="10" y="85" font-family="JetBrains Mono, monospace" font-size="11" fill="#4caf50">✔ 允许缓冲区重用</text>
    </g>

    <!-- Transition Logic -->
    <path d="M 500 120 L 500 180" fill="none" stroke="#ff9800" stroke-width="2" marker-end="url(#arrowhead_orange)" />
    <text x="510" y="160" font-family="JetBrains Mono, monospace" font-size="12" fill="#ff9800">逐步处理 &amp; 原位写入</text>

    <!-- Stage 3: Collection In-place -->
    <g transform="translate(300, 200)">
        <rect width="400" height="60" fill="#ffffff" stroke="#4caf50" stroke-width="2" stroke-dasharray="4" />
        <!-- Processing items -->
        <rect x="0" y="0" width="100" height="60" fill="#fff8e1" stroke="#ff9800" stroke-width="2" />
        <text x="50" y="35" font-family="JetBrains Mono, monospace" font-size="12" text-anchor="middle" font-weight="bold">U1</text>
        <rect x="100" y="0" width="100" height="60" fill="#fff8e1" stroke="#ff9800" stroke-width="2" />
        <text x="150" y="35" font-family="JetBrains Mono, monospace" font-size="12" text-anchor="middle" font-weight="bold">U2</text>
        <text x="250" y="35" font-family="JetBrains Mono, monospace" font-size="12" text-anchor="middle" fill="#78909c">T3 (待处理)</text>
        <text x="350" y="35" font-family="JetBrains Mono, monospace" font-size="12" text-anchor="middle" fill="#78909c">T4 (待处理)</text>
    </g>

    <!-- Stage 4: Final Vec -->
    <g transform="translate(50, 350)">
        <text x="0" y="-10" font-family="JetBrains Mono, monospace" font-size="14" font-weight="bold" fill="#2196f3">3. 结果 Vec (v2)</text>
        <rect width="180" height="80" rx="5" fill="#e3f2fd" stroke="#2196f3" stroke-width="2" />
        <text x="10" y="25" font-family="JetBrains Mono, monospace" font-size="12" fill="#333333">ptr: 0x1000 (重用!)</text>
        <text x="10" y="45" font-family="JetBrains Mono, monospace" font-size="12" fill="#333333">cap: 4, len: 4</text>
    </g>

    <g transform="translate(300, 350)">
        <text x="0" y="-10" font-family="JetBrains Mono, monospace" font-size="14" font-weight="bold" fill="#4caf50">Heap Buffer (0x1000)</text>
        <rect width="400" height="60" fill="#ffffff" stroke="#4caf50" stroke-width="2" />
        <rect x="0" y="0" width="100" height="60" fill="#e8f5e9" stroke="#4caf50" stroke-width="1" />
        <text x="50" y="35" font-family="JetBrains Mono, monospace" font-size="12" text-anchor="middle">U1</text>
        <rect x="100" y="0" width="100" height="60" fill="#e8f5e9" stroke="#4caf50" stroke-width="1" />
        <text x="150" y="35" font-family="JetBrains Mono, monospace" font-size="12" text-anchor="middle">U2</text>
        <rect x="200" y="0" width="100" height="60" fill="#e8f5e9" stroke="#4caf50" stroke-width="1" />
        <text x="250" y="35" font-family="JetBrains Mono, monospace" font-size="12" text-anchor="middle">U3</text>
        <rect x="300" y="0" width="100" height="60" fill="#e8f5e9" stroke="#4caf50" stroke-width="1" />
        <text x="350" y="35" font-family="JetBrains Mono, monospace" font-size="12" text-anchor="middle">U4</text>
    </g>

    <!-- Annotation -->
    <rect x="450" y="280" width="300" height="60" rx="5" fill="#fff8e1" stroke="#ff9800" stroke-width="1" />
    <text x="460" y="300" font-family="JetBrains Mono, monospace" font-size="11" fill="#333333">条件：T 与 U 的 Layout (Size &amp; Align) 必须兼容</text>
    <text x="460" y="320" font-family="JetBrains Mono, monospace" font-size="11" fill="#333333">且迭代器必须支持 InPlaceIterable</text>

    <!-- Definitions -->
    <defs>
        <marker id="arrowhead_orange" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
            <polygon points="0 0, 10 3.5, 0 7" fill="#ff9800" />
        </marker>
    </defs>
</svg>
