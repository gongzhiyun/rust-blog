<?xml version="1.0" encoding="UTF-8"?>
<svg width="850" height="550" viewBox="0 0 850 550" xmlns="http://www.w3.org/2000/svg">
<rect width="850" height="550" fill="#f8f9fa" rx="12"/>
<text x="425" y="40" font-family="JetBrains Mono, monospace" font-size="22" font-weight="bold" fill="#333" text-anchor="middle">图解：对象安全性 (Object Safety) 与 dyn Trait</text>
<!-- 虚表结构剖析 -->
<g transform="translate(40, 70)">
<rect width="320" height="440" fill="#ffffff" stroke="#e0e0e0" stroke-width="2" rx="10"/>
<text x="160" y="35" font-family="JetBrains Mono, monospace" font-size="16" font-weight="bold" fill="#2196f3" text-anchor="middle">vtable (虚表) 布局</text>
<!-- 基础条目 -->
<rect x="20" y="60" width="280" height="40" fill="#e3f2fd" stroke="#2196f3" rx="4"/>
<text x="35" y="85" font-family="JetBrains Mono, monospace" font-size="12" fill="#333">drop_in_place (析构函数)</text>
<rect x="20" y="105" width="280" height="40" fill="#e3f2fd" stroke="#2196f3" rx="4"/>
<text x="35" y="130" font-family="JetBrains Mono, monospace" font-size="12" fill="#333">size &amp; align (大小与对齐)</text>
<!-- 安全方法 -->
<rect x="20" y="150" width="280" height="40" fill="#e8f5e9" stroke="#4caf50" rx="4"/>
<text x="35" y="175" font-family="JetBrains Mono, monospace" font-size="12" fill="#333">method_ok(&amp;self)</text>
<!-- 冲突区域 -->
<rect x="20" y="200" width="280" height="180" fill="#ffebee" stroke="#ef5350" stroke-dasharray="5,5" rx="6"/>
<text x="160" y="225" font-family="JetBrains Mono, monospace" font-size="13" font-weight="bold" fill="#ef5350" text-anchor="middle">禁区：非对象安全成员</text>
<!-- 泛型冲突 -->
<g transform="translate(30, 240)">
<rect width="260" height="50" fill="#ffffff" stroke="#ef5350" rx="4"/>
<text x="10" y="20" font-family="JetBrains Mono, monospace" font-size="11" fill="#333">fn generic&lt;T&gt;(&amp;self)</text>
<text x="10" y="40" font-family="JetBrains Mono, monospace" font-size="10" fill="#455a64">原因：泛型导致副本无限，无法索引</text>
</g>
<!-- Self 冲突 -->
<g transform="translate(30, 300)">
<rect width="260" height="50" fill="#ffffff" stroke="#ef5350" rx="4"/>
<text x="10" y="20" font-family="JetBrains Mono, monospace" font-size="11" fill="#333">fn return_self() -&gt; Self</text>
<text x="10" y="40" font-family="JetBrains Mono, monospace" font-size="10" fill="#455a64">原因：Self 大小在 dyn 时不可知</text>
</g>
<text x="160" y="420" font-family="JetBrains Mono, monospace" font-size="11" fill="#c62828" text-anchor="middle" font-weight="bold">编译器结论：该 Trait 无法构建虚表</text>
</g>
<!-- 解决方案与修复 -->
<g transform="translate(400, 70)">
<rect width="410" height="440" fill="#ffffff" stroke="#e0e0e0" stroke-width="2" rx="10"/>
<text x="205" y="35" font-family="JetBrains Mono, monospace" font-size="16" font-weight="bold" fill="#7b1fa2" text-anchor="middle">修复方案：精准手术</text>
<!-- 方案 1: Sized 约束 -->
<g transform="translate(20, 60)">
<rect width="370" height="150" fill="#f3e5f5" stroke="#9c27b0" rx="6"/>
<text x="15" y="25" font-family="JetBrains Mono, monospace" font-size="13" font-weight="bold" fill="#333">1. 排除非安全方法 (Self: Sized)</text>
<text x="15" y="55" font-family="JetBrains Mono, monospace" font-size="11" fill="#455a64">// 告诉编译器：该方法仅限已知大小类型</text>
<rect x="15" y="70" width="340" height="60" fill="#ffffff" stroke="#b0bec5" rx="4"/>
<text x="25" y="90" font-family="JetBrains Mono, monospace" font-size="11" fill="#333">fn bad_method(&amp;self) -&gt; Self</text>
<text x="25" y="115" font-family="JetBrains Mono, monospace" font-size="11" fill="#7b1fa2" font-weight="bold">where Self: Sized;</text>
<text x="185" y="145" font-family="JetBrains Mono, monospace" font-size="10" fill="#2e7d32" text-anchor="middle">✅ dyn Trait 会自动跳过此方法，从而安全</text>
</g>
<!-- 方案 2: 擦除 -->
<g transform="translate(20, 230)">
<rect width="370" height="170" fill="#f3e5f5" stroke="#9c27b0" rx="6"/>
<text x="15" y="25" font-family="JetBrains Mono, monospace" font-size="13" font-weight="bold" fill="#333">2. 类型擦除 (Type Erasure)</text>
<text x="15" y="55" font-family="JetBrains Mono, monospace" font-size="11" fill="#455a64">// 将泛型转化为动态分发</text>
<rect x="15" y="70" width="340" height="80" fill="#ffffff" stroke="#b0bec5" rx="4"/>
<text x="25" y="90" font-family="JetBrains Mono, monospace" font-size="11" fill="#455a64">// 修改前: fn exec&lt;T: Display&gt;(&amp;self, x: T)</text>
<text x="25" y="115" font-family="JetBrains Mono, monospace" font-size="11" fill="#333">fn exec(&amp;self, x: </text>
<text x="145" y="115" font-family="JetBrains Mono, monospace" font-size="11" fill="#c62828" font-weight="bold">&amp;dyn Display</text>
<text x="245" y="115" font-family="JetBrains Mono, monospace" font-size="11" fill="#333">)</text>
<text x="185" y="160" font-family="JetBrains Mono, monospace" font-size="10" fill="#2e7d32" text-anchor="middle">✅ 将编译期多态转为运行时多态</text>
</g>
<text x="205" y="420" font-family="JetBrains Mono, monospace" font-size="11" fill="#455a64" text-anchor="middle">注：dyn Trait 只能调用“对象安全”的方法</text>
</g>
</svg>