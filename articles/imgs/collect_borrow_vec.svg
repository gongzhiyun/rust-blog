<?xml version="1.0" encoding="UTF-8"?>
<svg width="880" height="900" viewBox="0 0 880 900" xmlns="http://www.w3.org/2000/svg" shape-rendering="geometricPrecision" text-rendering="geometricPrecision">
  <!-- Background -->
  <rect width="880" height="900" fill="#f8f9fa" />
  <!-- Title -->
  <text x="440" y="35" font-family="JetBrains Mono, monospace" font-size="22" font-weight="bold" text-anchor="middle" fill="#333333">借用与新分配 (Borrow &amp; Allocation)</text>
  <!-- Main Container -->
  <g transform="translate(40, 70)">
    <rect x="-10" y="-5" width="810" height="820" rx="15" fill="#fff" stroke="#e0e0e0" stroke-width="1.5" />
    
    <!-- Left Column: Stack (Memory Layout) -->
    <g transform="translate(20, 20)">
      <rect width="360" height="780" rx="12" fill="#ffffff" stroke="#e0e0e0" stroke-width="1" />
      <rect width="360" height="35" rx="12" fill="#e3f2fd" />
      <rect y="20" width="360" height="15" fill="#e3f2fd" />
      <text x="180" y="22" font-family="JetBrains Mono, monospace" font-size="14" font-weight="bold" fill="#1565c0" text-anchor="middle">Stack (内存栈数据)</text>

      <!-- 0. Source Vec v1 View -->
      <g transform="translate(20, 70)">
        <rect width="320" height="150" rx="8" fill="#ffffff" stroke="#90a4ae" stroke-width="2" stroke-dasharray="4 2"/>
        <text x="10" y="-8" font-family="JetBrains Mono, monospace" font-size="11" font-weight="bold" fill="#546e7a">Vec&lt;i32&gt; v1 (源数据容器)</text>
        <g transform="translate(15, 15)">
          <g transform="translate(0, 0)">
            <rect width="290" height="35" fill="#fff8e1" stroke="#ff9800" rx="4"/>
            <text x="10" y="22" font-family="JetBrains Mono, monospace" font-size="10" fill="#546e7a">ptr</text>
            <text x="280" y="22" font-family="JetBrains Mono, monospace" font-size="10" font-weight="bold" fill="#f57c00" text-anchor="end">0x500</text>
          </g>
          <g transform="translate(0, 45)">
            <rect width="290" height="35" fill="#f5f5f5" rx="4"/>
            <text x="10" y="22" font-family="JetBrains Mono, monospace" font-size="10" fill="#546e7a">cap</text>
            <text x="280" y="22" font-family="JetBrains Mono, monospace" font-size="10" font-weight="bold" fill="#333" text-anchor="end">10</text>
          </g>
          <g transform="translate(0, 90)">
            <rect width="290" height="35" fill="#e8f5e9" rx="4"/>
            <text x="10" y="22" font-family="JetBrains Mono, monospace" font-size="10" fill="#546e7a">len</text>
            <text x="280" y="22" font-family="JetBrains Mono, monospace" font-size="10" font-weight="bold" fill="#2e7d32" text-anchor="end">10</text>
          </g>
        </g>
        <text x="160" y="142" font-family="JetBrains Mono, monospace" font-size="8" fill="#78909c" text-anchor="middle">所有权由 v1 持有</text>
      </g>

      <!-- 1. Iterator Struct View -->
      <g transform="translate(20, 265)">
        <rect width="320" height="280" rx="8" fill="#ffffff" stroke="#ab47bc" stroke-width="2" stroke-dasharray="6 2"/>
        <text x="10" y="-8" font-family="JetBrains Mono, monospace" font-size="11" font-weight="bold" fill="#6a1b9a">Map&lt;Iter&lt;i32&gt;, [closure]&gt;</text>
        
        <!-- .iter field (Iter) -->
        <g transform="translate(15, 20)">
          <text x="0" y="12" font-family="JetBrains Mono, monospace" font-size="10" font-weight="bold" fill="#1565c0">.iter (Iter)</text>
          <rect y="20" width="290" height="150" rx="4" fill="#fafafa" stroke="#bbdefb" stroke-width="1.5"/>
          
          <g transform="translate(10, 40)">
            <g transform="translate(0, 0)">
              <rect width="270" height="40" fill="#fff8e1" stroke="#ff9800" stroke-width="1.5" rx="4"/>
              <text x="10" y="25" font-family="JetBrains Mono, monospace" font-size="10" fill="#e65100" font-weight="bold">ptr</text>
              <text x="260" y="25" font-family="JetBrains Mono, monospace" font-size="10" font-weight="bold" fill="#f57c00" text-anchor="end">0x500</text>
            </g>
            
            <g transform="translate(0, 50)">
              <rect width="270" height="40" fill="#f5f5f5" stroke="#cfd8dc" rx="4"/>
              <text x="10" y="25" font-family="JetBrains Mono, monospace" font-size="10" fill="#546e7a">end</text>
              <text x="260" y="25" font-family="JetBrains Mono, monospace" font-size="10" font-weight="bold" fill="#333" text-anchor="end">0x528</text>
            </g>
            
            <text x="135" y="122" font-family="JetBrains Mono, monospace" font-size="8" fill="#ef5350" font-weight="bold" text-anchor="middle">不持有所有权 仅只读借用</text>
          </g>
        </g>
        
        <!-- .f field -->
        <g transform="translate(15, 200)">
          <text x="0" y="12" font-family="JetBrains Mono, monospace" font-size="10" font-weight="bold" fill="#e65100">.f (闭包逻辑)</text>
          <rect y="20" width="290" height="40" rx="4" fill="#f3e5f5" fill-opacity="0.3" stroke="#9c27b0" stroke-width="1.5" stroke-dasharray="4 2"/>
          <text x="145" y="45" font-family="JetBrains Mono, monospace" font-size="10" font-weight="bold" fill="#6a1b9a" text-anchor="middle">静态绑定 (ZST) 0 Bytes</text>
        </g>
      </g>

      <!-- 2. Result Vec Struct -->
      <g transform="translate(20, 590)">
        <rect width="320" height="170" rx="8" fill="#ffffff" stroke="#4caf50" stroke-width="2"/>
        <text x="10" y="-8" font-family="JetBrains Mono, monospace" font-size="11" font-weight="bold" fill="#2e7d32">Vec&lt;i32&gt; v2 (新分配结果)</text>
        <g transform="translate(15, 15)">
          <g transform="translate(0, 0)">
            <rect width="290" height="40" fill="#fff8e1" stroke="#ff9800" rx="4"/>
            <text x="10" y="25" font-family="JetBrains Mono, monospace" font-size="10" fill="#546e7a">ptr</text>
            <text x="280" y="25" font-family="JetBrains Mono, monospace" font-size="10" font-weight="bold" fill="#f57c00" text-anchor="end">0x800</text>
          </g>
          <g transform="translate(0, 50)">
            <rect width="290" height="40" fill="#f5f5f5" rx="4"/>
            <text x="10" y="25" font-family="JetBrains Mono, monospace" font-size="10" fill="#546e7a">cap</text>
            <text x="280" y="25" font-family="JetBrains Mono, monospace" font-size="10" font-weight="bold" fill="#333" text-anchor="end">10</text>
          </g>
          <g transform="translate(0, 100)">
            <rect width="290" height="40" fill="#e8f5e9" stroke="#4caf50" rx="4"/>
            <text x="10" y="25" font-family="JetBrains Mono, monospace" font-size="10" fill="#546e7a">len</text>
            <text x="280" y="25" font-family="JetBrains Mono, monospace" font-size="10" font-weight="bold" fill="#2e7d32" text-anchor="end">10</text>
          </g>
        </g>
      </g>
    </g>

    <!-- Right Column: Heap (Top) & Code (Bottom) -->
    <g transform="translate(420, 20)">
      <!-- Heap Container -->
      <g>
        <rect width="360" height="340" rx="12" fill="#ffffff" stroke="#e0e0e0" stroke-width="1" />
        <rect width="360" height="35" rx="12" fill="#e8f5e9" />
        <rect y="20" width="360" height="15" fill="#e8f5e9" />
        <text x="180" y="22" font-family="JetBrains Mono, monospace" font-size="14" font-weight="bold" fill="#2e7d32" text-anchor="middle">Heap (堆内存隔离)</text>
        
        <!-- Original Data Block (Top) -->
        <g transform="translate(60, 55)">
          <rect width="240" height="100" fill="#f5f5f5" stroke="#bdbdbd" stroke-width="1.5" rx="4" />
          <text x="120" y="22" font-family="JetBrains Mono, monospace" font-size="11" fill="#546e7a" text-anchor="middle" font-weight="bold">源数据 (v1)</text>
          <text x="120" y="38" font-family="JetBrains Mono, monospace" font-size="9" fill="#78909c" text-anchor="middle">(0x500)</text>
          <text x="120" y="75" font-family="JetBrains Mono, monospace" font-size="11" fill="#9e9e9e" text-anchor="middle">只读不可写</text>
        </g>

        <!-- New Allocated Block (Bottom) -->
        <g transform="translate(60, 215)">
          <rect width="240" height="100" fill="#e8f5e9" stroke="#4caf50" stroke-width="2" rx="4" />
          <text x="120" y="22" font-family="JetBrains Mono, monospace" font-size="11" fill="#2e7d32" text-anchor="middle" font-weight="bold">新分配 (v2)</text>
          <text x="120" y="38" font-family="JetBrains Mono, monospace" font-size="9" fill="#2e7d32" text-anchor="middle">(0x800)</text>
          <text x="120" y="75" font-family="JetBrains Mono, monospace" font-size="11" fill="#2e7d32" text-anchor="middle" font-weight="bold">写入新结果</text>
        </g>
        
        <path d="M 180,155 L 180,210" stroke="#ef5350" stroke-width="1.5" marker-end="url(#arrow-red)" />
        <text x="195" y="185" font-family="JetBrains Mono, monospace" font-size="9" fill="#ef5350" text-anchor="start">必须新开辟</text>
      </g>

      <!-- Code Segment Container -->
      <g transform="translate(0, 360)">
        <rect width="360" height="420" rx="12" fill="#ffffff" stroke="#e0e0e0" stroke-width="1" />
        <rect width="360" height="35" rx="12" fill="#f3e5f5" />
        <rect y="20" width="360" height="15" fill="#f3e5f5" />
        <text x="180" y="22" font-family="JetBrains Mono, monospace" font-size="14" font-weight="bold" fill="#6a1b9a" text-anchor="middle">Code Segment (代码逻辑段)</text>
        
        <!-- size_hint() logic -->
        <g transform="translate(20, 60)">
          <rect width="320" height="40" rx="8" fill="#fff8e1" stroke="#ff9800" stroke-width="1.5" stroke-dasharray="4 2"/>
          <text x="10" y="18" font-family="JetBrains Mono, monospace" font-size="11" font-weight="bold" fill="#e65100">fn size_hint(&amp;self)</text>
          <text x="15" y="32" font-family="JetBrains Mono, monospace" font-size="10" fill="#2e7d32">return (10, Some(10));</text>
        </g>
        
        <!-- closure logic -->
        <g transform="translate(20, 125)">
          <rect width="320" height="55" rx="8" fill="#f3e5f5" stroke="#9c27b0" stroke-width="1.5" />
          <text x="10" y="22" font-family="JetBrains Mono, monospace" font-size="11" font-weight="bold" fill="#6a1b9a">闭包逻辑 (Closure Code)</text>
          <text x="15" y="42" font-family="JetBrains Mono, monospace" font-size="11" fill="#4a148c" font-style="italic">|&amp;x| x + 1  // 借用转换</text>
        </g>
        
        <!-- collect() logic -->
        <g transform="translate(20, 205)">
          <rect width="320" height="195" rx="8" fill="#ffffff" stroke="#ab47bc" stroke-dasharray="4 2" />
          <text x="10" y="22" font-family="JetBrains Mono, monospace" font-size="11" font-weight="bold" fill="#6a1b9a">fn collect&lt;B&gt;(self)</text>
          <g transform="translate(10, 42)">
            <text x="5" y="12" font-family="JetBrains Mono, monospace" font-size="10" fill="#455a64">1. 根据 size_hint 预分配新堆</text>
            <text x="5" y="40" font-family="JetBrains Mono, monospace" font-size="10" fill="#455a64">2. 从 v1.ptr (0x500) 读取数据</text>
            <text x="5" y="68" font-family="JetBrains Mono, monospace" font-size="10" fill="#455a64">3. 运行闭包并将结果写入 0x800</text>
            <text x="5" y="96" font-family="JetBrains Mono, monospace" font-size="10" fill="#455a64">4. v1 依然存活，无法重用指针</text>
            <text x="5" y="124" font-family="JetBrains Mono, monospace" font-size="10" fill="#455a64">5. 返回新 Vec (v2)</text>
          </g>
        </g>
      </g>
    </g>

    <!-- Connections -->
    <!-- v1 ptr to Heap (Original) -->
    <circle cx="345" cy="122.5" r="3.5" fill="#ff9800" />
    <path d="M 345,122.5 C 390,122.5 440,125 480,125" fill="none" stroke="#ff9800" stroke-width="1.5" stroke-linecap="round" marker-end="url(#arrow-orange)" />

    <!-- Iterator ptr to Heap (Original) -->
    <circle cx="335" cy="365" r="3.5" fill="#ff9800" />
    <path d="M 335,365 C 380,365 440,125 480,125" fill="none" stroke="#ff9800" stroke-width="1.5" stroke-dasharray="2 2" stroke-linecap="round" marker-end="url(#arrow-orange)" />

    <!-- v2 ptr to Heap (New) -->
    <circle cx="345" cy="645" r="3.5" fill="#ff9800" />
    <path d="M 345,645 C 400,645 440,285 480,285" fill="none" stroke="#ff9800" stroke-width="2.5" stroke-linecap="round" marker-end="url(#arrow-orange)" />

    <!-- Logic Connections -->
    <!-- Iterator to size_hint logic -->
    <circle cx="335" cy="385" r="3.5" fill="#bbdefb" />
    <path d="M 335,385 C 380,385 405,460 440,460" fill="none" stroke="#bbdefb" stroke-width="1.5" stroke-dasharray="2 2" stroke-linecap="round" marker-end="url(#arrow-purple)" />

    <!-- Iterator closure to Code Logic -->
    <circle cx="345" cy="505" r="3.5" fill="#ab47bc" />
    <path d="M 345,505 C 380,505 405,532.5 440,532.5" fill="none" stroke="#ab47bc" stroke-width="1.5" stroke-dasharray="2 2" stroke-linecap="round" marker-end="url(#arrow-call)" />
  </g>

  <!-- Markers & Definitions -->
  <defs>
    <marker id="arrow-orange" markerWidth="12" markerHeight="8" refX="12" refY="4" orient="auto" markerUnits="userSpaceOnUse">
      <path d="M0,0 L12,4 L0,8 Z" fill="#ff9800" />
    </marker>
    <marker id="arrow-purple" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto" markerUnits="userSpaceOnUse">
      <path d="M0,0 L10,3.5 L0,7 Z" fill="#9c27b0" />
    </marker>
    <marker id="arrow-call" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto" markerUnits="userSpaceOnUse">
      <path d="M0,0 L10,3.5 L0,7 Z" fill="#6a1b9a" />
    </marker>
    <marker id="arrow-red" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto" markerUnits="userSpaceOnUse">
      <path d="M0,0 L8,3 L0,6 Z" fill="#ef5350" />
    </marker>
  </defs>
</svg>