<?xml version="1.0" encoding="UTF-8"?>
<svg width="800" height="900" viewBox="0 0 800 900" xmlns="http://www.w3.org/2000/svg" shape-rendering="geometricPrecision" text-rendering="geometricPrecision">
  <!-- Background -->
  <rect width="800" height="900" fill="#f8f9fa" />
  <!-- Title -->
  <text x="400" y="35" font-family="JetBrains Mono, monospace" font-size="22" font-weight="bold" text-anchor="middle" fill="#333333">情况三：Iter 借用并分配新内存 (New Allocation from Borrow)</text>
  <!-- Main Container -->
  <g transform="translate(40, 70)">
    <rect x="-10" y="-5" width="730" height="800" rx="15" fill="#fff" stroke="#e0e0e0" stroke-width="1.5" />
    <!-- Left Column: Stack -->
    <g transform="translate(20, 20)">
      <rect width="340" height="760" rx="12" fill="#ffffff" stroke="#e0e0e0" stroke-width="1" />
      <rect width="340" height="35" rx="12" fill="#e3f2fd" />
      <rect y="20" width="340" height="15" fill="#e3f2fd" />
      <text x="170" y="22" font-family="JetBrains Mono, monospace" font-size="14" font-weight="bold" fill="#1565c0" text-anchor="middle">Stack (内存栈)</text>
      <!-- Iterator -->
      <g transform="translate(20, 60)">
        <rect width="300" height="280" rx="8" fill="#ffffff" stroke="#ab47bc" stroke-width="2" stroke-dasharray="6 2"/>
        <text x="10" y="-8" font-family="JetBrains Mono, monospace" font-size="11" font-weight="bold" fill="#6a1b9a">Map&lt;Iter&lt;'a, i32&gt;, [closure]&gt;</text>
        <g transform="translate(15, 20)">
          <text x="0" y="12" font-family="JetBrains Mono, monospace" font-size="10" font-weight="bold" fill="#1565c0">.iter (Iter)</text>
          <rect y="20" width="270" height="130" rx="4" fill="#fafafa" stroke="#bbdefb" stroke-width="1.5"/>
          <g transform="translate(10, 40)">
            <rect width="250" height="35" fill="#fff8e1" rx="4"/>
            <text x="10" y="22" font-family="JetBrains Mono, monospace" font-size="10" fill="#546e7a">ptr: 0x500 (借用原数组)</text>
            <rect y="45" width="250" height="35" fill="#f5f5f5" rx="4"/>
            <text x="10" y="67" font-family="JetBrains Mono, monospace" font-size="10" fill="#546e7a">end: 0x528</text>
          </g>
        </g>
        <g transform="translate(15, 190)">
          <text x="0" y="12" font-family="JetBrains Mono, monospace" font-size="10" font-weight="bold" fill="#e65100">.f (ZST 闭包)</text>
          <rect y="20" width="270" height="50" rx="4" fill="#f3e5f5" stroke="#9c27b0" stroke-width="1.5" stroke-dasharray="4 2"/>
          <text x="135" y="52" font-family="JetBrains Mono, monospace" font-size="10" font-weight="bold" fill="#6a1b9a" text-anchor="middle">0 Bytes</text>
        </g>
      </g>
      <!-- Result Vec -->
      <g transform="translate(20, 380)">
        <rect width="300" height="180" rx="8" fill="#ffffff" stroke="#4caf50" stroke-width="2"/>
        <text x="10" y="-8" font-family="JetBrains Mono, monospace" font-size="11" font-weight="bold" fill="#2e7d32">Vec&lt;i32&gt; (新分配)</text>
        <g transform="translate(15, 20)">
          <rect width="270" height="40" fill="#fff8e1" stroke="#ff9800" rx="4"/>
          <text x="10" y="25" font-family="JetBrains Mono, monospace" font-size="10" fill="#546e7a">ptr: 0x800 (新堆地址)</text>
          <rect y="50" width="270" height="40" fill="#f5f5f5" rx="4"/>
          <text x="10" y="75" font-family="JetBrains Mono, monospace" font-size="10" fill="#546e7a">cap: 10</text>
          <rect y="100" width="270" height="40" fill="#e8f5e9" stroke="#4caf50" rx="4"/>
          <text x="10" y="125" font-family="JetBrains Mono, monospace" font-size="10" fill="#546e7a">len: 10</text>
        </g>
      </g>
    </g>
    <!-- Right Column: Heap & Code -->
    <g transform="translate(390, 20)">
      <!-- Heap -->
      <rect width="320" height="380" rx="12" fill="#ffffff" stroke="#e0e0e0" stroke-width="1" />
      <rect width="320" height="35" rx="12" fill="#e8f5e9" />
      <text x="160" y="22" font-family="JetBrains Mono, monospace" font-size="14" font-weight="bold" fill="#2e7d32" text-anchor="middle">Heap (堆内存布局)</text>
      <!-- Original Block -->
      <g transform="translate(60, 50)">
        <rect width="200" height="120" fill="#f5f5f5" stroke="#bdbdbd" rx="4" />
        <text x="100" y="25" font-family="JetBrains Mono, monospace" font-size="12" fill="#546e7a" text-anchor="middle">原数据 (0x500)</text>
        <text x="100" y="70" font-family="JetBrains Mono, monospace" font-size="10" fill="#9e9e9e" text-anchor="middle">只读借用</text>
      </g>
      <!-- New Block -->
      <g transform="translate(60, 200)">
        <rect width="200" height="120" fill="#e8f5e9" stroke="#4caf50" stroke-width="2" rx="4" />
        <text x="100" y="25" font-family="JetBrains Mono, monospace" font-size="12" fill="#2e7d32" font-weight="bold" text-anchor="middle">新分配 (0x800)</text>
        <text x="100" y="70" font-family="JetBrains Mono, monospace" font-size="10" fill="#4caf50" text-anchor="middle">写入计算结果</text>
      </g>
      <!-- Code Logic -->
      <g transform="translate(0, 400)">
        <rect width="320" height="360" rx="12" fill="#f3e5f5" stroke="#9c27b0" stroke-width="1.5" />
        <text x="160" y="25" font-family="JetBrains Mono, monospace" font-size="14" font-weight="bold" fill="#6a1b9a" text-anchor="middle">Code Logic</text>
        <g transform="translate(15, 60)">
          <rect width="290" height="240" rx="8" fill="#ffffff" stroke="#ab47bc" stroke-dasharray="4 2" />
          <text x="15" y="40" font-family="JetBrains Mono, monospace" font-size="10" fill="#455a64">1. iter() 产生借用 &amp;T</text>
          <text x="15" y="70" font-family="JetBrains Mono, monospace" font-size="10" fill="#455a64">2. 原 Vec 仍在使用中</text>
          <text x="15" y="100" font-family="JetBrains Mono, monospace" font-size="10" fill="#455a64">3. collect 必须申请新空间</text>
          <text x="145" y="180" font-family="JetBrains Mono, monospace" font-size="11" fill="#9c27b0" font-weight="bold" text-anchor="middle">物理隔离的内存布局</text>
        </g>
      </g>
    </g>
    <!-- Connections -->
    <defs>
      <marker id="arrow-orange" markerWidth="10" markerHeight="10" refX="9" refY="5" orient="auto"><path d="M0,0 L10,5 L0,10 Z" fill="#ff9800" /></marker>
    </defs>
    <!-- From Iter to Original -->
    <circle cx="285" cy="130" r="3" fill="#ff9800" />
    <path d="M 285,130 C 350,130 380,100 450,100" fill="none" stroke="#ff9800" stroke-width="1.5" stroke-dasharray="2 2" marker-end="url(#arrow-orange)" />
    <!-- From Result Vec to New -->
    <circle cx="285" cy="420" r="3" fill="#ff9800" />
    <path d="M 285,420 C 350,420 380,300 450,300" fill="none" stroke="#ff9800" stroke-width="2.5" marker-end="url(#arrow-orange)" />
  </g>
</svg>