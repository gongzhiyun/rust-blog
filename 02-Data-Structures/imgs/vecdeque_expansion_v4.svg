<?xml version="1.0" encoding="UTF-8"?>
<svg width="800" height="1000" viewBox="0 0 800 1000" fill="none" xmlns="http://www.w3.org/2000/svg" shape-rendering="geometricPrecision" text-rendering="geometricPrecision">
<rect width="800" height="1000" rx="15" fill="#f8f9fa"/>
<defs>
<style>
.label { font-family: 'JetBrains Mono', monospace; font-size: 11px; fill: #546e7a; }
.value { font-family: 'JetBrains Mono', monospace; font-size: 11px; font-weight: bold; fill: #333; }
.header { font-family: 'JetBrains Mono', monospace; font-size: 14px; font-weight: bold; fill: #1565c0; }
.heap-header { font-family: 'JetBrains Mono', monospace; font-size: 14px; font-weight: bold; fill: #2e7d32; }
.ptr-label { font-family: 'JetBrains Mono', monospace; font-size: 10px; font-weight: bold; fill: #f57c00; }
.head-label { font-family: 'JetBrains Mono', monospace; font-size: 10px; font-weight: bold; fill: #1565c0; }
.index { font-family: 'JetBrains Mono', monospace; font-size: 10px; fill: #78909c; }
.code-box { font-family: 'JetBrains Mono', monospace; font-size: 13px; fill: #6a1b9a; font-weight: bold; }
.sub-header { font-family: 'JetBrains Mono', monospace; font-size: 10px; font-weight: bold; fill: #7b1fa2; }
.step-title { font-family: 'JetBrains Mono', monospace; font-size: 16px; font-weight: bold; fill: #333; }
</style>
<marker id="arrowhead-ptr" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
<polygon points="0 0, 10 3.5, 0 7" fill="#ff9800" />
</marker>
<marker id="arrowhead-head" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
<polygon points="0 0, 10 3.5, 0 7" fill="#1565c0" />
</marker>
<marker id="arrowhead-migration" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
<polygon points="0 0, 10 3.5, 0 7" fill="#9c27b0" />
</marker>
</defs>
<!-- Step 1: Full and Wrapped -->
<g transform="translate(30, 40)">
<text x="0" y="-10" class="step-title">1. 扩容前：已满且回绕 (cap=4, head=2)</text>
<rect width="740" height="220" rx="12" fill="#ffffff" stroke="#e0e0e0"/>
<g transform="translate(20, 30)">
<rect width="180" height="170" rx="8" fill="#ffffff" stroke="#e0e0e0"/>
<rect width="180" height="25" rx="8" fill="#e3f2fd"/>
<text x="90" y="17" text-anchor="middle" class="header">Stack (VecDeque)</text>
<g transform="translate(10, 35)">
<rect width="160" height="22" rx="4" fill="#ffffff" stroke="#1565c0" stroke-width="1.5"/>
<text x="8" y="15" class="label">head</text>
<text x="152" y="15" class="value" text-anchor="end">2</text>
<g transform="translate(0, 27)">
<rect width="160" height="22" rx="4" fill="#ffffff" stroke="#e0e0e0"/>
<text x="8" y="15" class="label">len</text>
<text x="152" y="15" class="value" text-anchor="end">4</text>
</g>
<g transform="translate(0, 55)">
<rect width="160" height="75" rx="6" fill="#f8f0fb" stroke="#9c27b0" stroke-dasharray="2 2"/>
<text x="8" y="14" class="sub-header">buf: RawVec</text>
<g transform="translate(5, 20)">
<rect width="150" height="22" rx="4" fill="#fff8e1" stroke="#ff9800"/>
<text x="8" y="15" class="label">ptr</text>
<text x="142" y="15" class="value" text-anchor="end" fill="#f57c00">0x55aa</text>
</g>
<g transform="translate(5, 47)">
<rect width="150" height="22" rx="4" fill="#ffffff" stroke="#e0e0e0"/>
<text x="8" y="15" class="label">cap</text>
<text x="142" y="15" class="value" text-anchor="end">4</text>
</g>
</g>
</g>
</g>
<g transform="translate(240, 30)">
<rect width="480" height="170" rx="8" fill="#ffffff" stroke="#e0e0e0"/>
<rect width="480" height="25" rx="8" fill="#e8f5e9"/>
<text x="240" y="17" text-anchor="middle" class="heap-header">Heap (Ring Buffer)</text>
<g transform="translate(20, 60)">
<rect x="0" y="0" width="45" height="45" rx="4" fill="#e3f2fd" stroke="#1565c0" stroke-width="2"/><text x="22.5" y="27" text-anchor="middle" font-family="JetBrains Mono" font-size="14" font-weight="bold" fill="#1565c0">C</text><text x="22.5" y="60" text-anchor="middle" class="index">[0]</text>
<rect x="55" y="0" width="45" height="45" rx="4" fill="#e3f2fd" stroke="#1565c0" stroke-width="2"/><text x="77.5" y="27" text-anchor="middle" font-family="JetBrains Mono" font-size="14" font-weight="bold" fill="#1565c0">D</text><text x="77.5" y="60" text-anchor="middle" class="index">[1]</text>
<rect x="110" y="0" width="45" height="45" rx="4" fill="#fff8e1" stroke="#ff9800" stroke-width="2"/><text x="132.5" y="27" text-anchor="middle" font-family="JetBrains Mono" font-size="14" font-weight="bold" fill="#f57c00">A</text><text x="132.5" y="60" text-anchor="middle" class="index">[2]</text>
<rect x="165" y="0" width="45" height="45" rx="4" fill="#fff8e1" stroke="#ff9800" stroke-width="2"/><text x="187.5" y="27" text-anchor="middle" font-family="JetBrains Mono" font-size="14" font-weight="bold" fill="#f57c00">B</text><text x="187.5" y="60" text-anchor="middle" class="index">[3]</text>
<path d="M132.5 95 V65" stroke="#1565c0" stroke-width="1.5" marker-end="url(#arrowhead-head)"/>
<text x="132.5" y="105" text-anchor="middle" class="head-label">head</text>
</g>
</g>
</g>
<!-- Step 2: Realloc & Migration -->
<g transform="translate(30, 310)">
<text x="0" y="-10" class="step-title">2. 搬迁与解旋 (Unwrapping)</text>
<rect width="740" height="380" rx="12" fill="#ffffff" stroke="#e0e0e0"/>
<!-- Old Heap Container -->
<g transform="translate(200, 30)">
<rect width="360" height="110" rx="8" fill="#ffffff" stroke="#e0e0e0"/>
<rect width="360" height="25" rx="8" fill="#e8f5e9"/>
<text x="180" y="17" text-anchor="middle" class="heap-header">Heap (Old: 0x55aa)</text>
<g transform="translate(85, 45)">
<rect x="0" y="0" width="40" height="40" rx="4" fill="#e3f2fd" stroke="#1565c0"/><text x="20" y="25" text-anchor="middle" class="value" fill="#1565c0">C</text><text x="20" y="55" text-anchor="middle" class="index">[0]</text>
<rect x="45" y="0" width="40" height="40" rx="4" fill="#e3f2fd" stroke="#1565c0"/><text x="65" y="25" text-anchor="middle" class="value" fill="#1565c0">D</text><text x="65" y="55" text-anchor="middle" class="index">[1]</text>
<rect x="90" y="0" width="40" height="40" rx="4" fill="#fff8e1" stroke="#ff9800" stroke-width="2"/><text x="110" y="25" text-anchor="middle" class="value" fill="#f57c00">A</text><text x="110" y="55" text-anchor="middle" class="index">[2]</text>
<rect x="135" y="0" width="40" height="40" rx="4" fill="#fff8e1" stroke="#ff9800" stroke-width="2"/><text x="155" y="25" text-anchor="middle" class="value" fill="#f57c00">B</text><text x="155" y="55" text-anchor="middle" class="index">[3]</text>
</g>
</g>
<!-- New Heap Container -->
    <g transform="translate(100, 240)">
      <rect width="540" height="110" rx="8" fill="#ffffff" stroke="#e0e0e0"/>
      <rect width="540" height="25" rx="8" fill="#e8f5e9"/>
      <text x="270" y="17" text-anchor="middle" class="heap-header">Heap (New: 0x99bb)</text>
      <g transform="translate(90, 45)">
        <!-- Destination Slots with Data -->
        <rect x="0" y="0" width="40" height="40" rx="4" fill="#fff8e1" stroke="#ff9800" stroke-width="1" opacity="0.6"/>
        <text x="20" y="25" text-anchor="middle" class="value" fill="#f57c00" opacity="0.6">A</text>
        <text x="20" y="55" text-anchor="middle" class="index">[0]</text>
        
        <rect x="45" y="0" width="40" height="40" rx="4" fill="#fff8e1" stroke="#ff9800" stroke-width="1" opacity="0.6"/>
        <text x="65" y="25" text-anchor="middle" class="value" fill="#f57c00" opacity="0.6">B</text>
        <text x="65" y="55" text-anchor="middle" class="index">[1]</text>
        
        <rect x="90" y="0" width="40" height="40" rx="4" fill="#e3f2fd" stroke="#1565c0" stroke-width="1" opacity="0.6"/>
        <text x="110" y="25" text-anchor="middle" class="value" fill="#1565c0" opacity="0.6">C</text>
        <text x="110" y="55" text-anchor="middle" class="index">[2]</text>
        
        <rect x="135" y="0" width="40" height="40" rx="4" fill="#e3f2fd" stroke="#1565c0" stroke-width="1" opacity="0.6"/>
        <text x="155" y="25" text-anchor="middle" class="value" fill="#1565c0" opacity="0.6">D</text>
        <text x="155" y="55" text-anchor="middle" class="index">[3]</text>
        
        <!-- Empty Slots -->
        <rect x="180" y="0" width="40" height="40" rx="4" fill="#ffffff" stroke="#e0e0e0" stroke-dasharray="3 2"/><text x="200" y="55" text-anchor="middle" class="index">[4]</text>
        <rect x="225" y="0" width="40" height="40" rx="4" fill="#ffffff" stroke="#e0e0e0" stroke-dasharray="3 2"/><text x="245" y="55" text-anchor="middle" class="index">[5]</text>
        <rect x="270" y="0" width="40" height="40" rx="4" fill="#ffffff" stroke="#e0e0e0" stroke-dasharray="3 2"/><text x="290" y="55" text-anchor="middle" class="index">[6]</text>
        <rect x="315" y="0" width="40" height="40" rx="4" fill="#ffffff" stroke="#e0e0e0" stroke-dasharray="3 2"/><text x="335" y="55" text-anchor="middle" class="index">[7]</text>
      </g>
    </g>
    <!-- Migration Arrows -->
    <!-- A, B: from old[2,3] to new[0,1] -->
    <path d="M395 115 Q300 200 210 285" stroke="#ff9800" stroke-width="2" stroke-dasharray="4 2" fill="none" marker-end="url(#arrowhead-migration)"/>
    <path d="M440 115 Q350 200 255 285" stroke="#ff9800" stroke-width="2" stroke-dasharray="4 2" fill="none" marker-end="url(#arrowhead-migration)"/>
    <text x="450" y="180" class="label" fill="#f57c00" font-weight="bold">1. 拷贝 [head..end] 到起点</text>
    <!-- C, D: from old[0,1] to new[2,3] -->
    <path d="M305 115 Q300 200 300 285" stroke="#1565c0" stroke-width="2" stroke-dasharray="4 2" fill="none" marker-end="url(#arrowhead-migration)"/>
    <path d="M350 115 Q350 200 345 285" stroke="#1565c0" stroke-width="2" stroke-dasharray="4 2" fill="none" marker-end="url(#arrowhead-migration)"/>
    <text x="450" y="210" class="label" fill="#1565c0" font-weight="bold">2. 拷贝 [0..head] 接在后面</text>
</g>
<!-- Step 3: Final State -->
<g transform="translate(30, 740)">
<text x="0" y="-10" class="step-title">3. 扩容后：逻辑与物理重新对齐 (cap=8, head=0)</text>
<rect width="740" height="220" rx="12" fill="#ffffff" stroke="#e0e0e0"/>
<g transform="translate(20, 30)">
<rect width="180" height="170" rx="8" fill="#ffffff" stroke="#e0e0e0"/>
<rect width="180" height="25" rx="8" fill="#e3f2fd"/>
<text x="90" y="17" text-anchor="middle" class="header">Stack (VecDeque)</text>
<g transform="translate(10, 35)">
<rect width="160" height="22" rx="4" fill="#ffffff" stroke="#1565c0" stroke-width="1.5"/>
<text x="8" y="15" class="label">head</text>
<text x="152" y="15" class="value" text-anchor="end">0</text>
<g transform="translate(0, 27)">
<rect width="160" height="22" rx="4" fill="#ffffff" stroke="#e0e0e0"/>
<text x="8" y="15" class="label">len</text>
<text x="152" y="15" class="value" text-anchor="end">4</text>
</g>
<g transform="translate(0, 55)">
<rect width="160" height="75" rx="6" fill="#f8f0fb" stroke="#9c27b0" stroke-dasharray="2 2"/>
<text x="8" y="14" class="sub-header">buf: RawVec</text>
<g transform="translate(5, 20)">
<rect width="150" height="22" rx="4" fill="#fff8e1" stroke="#ff9800"/>
<text x="8" y="15" class="label">ptr</text>
<text x="142" y="15" class="value" text-anchor="end" fill="#f57c00">0x99bb</text>
</g>
<g transform="translate(5, 47)">
<rect width="150" height="22" rx="4" fill="#ffffff" stroke="#e0e0e0"/>
<text x="8" y="15" class="label">cap</text>
<text x="142" y="15" class="value" text-anchor="end">8</text>
</g>
</g>
</g>
</g>
<g transform="translate(240, 30)">
<rect width="480" height="170" rx="8" fill="#ffffff" stroke="#e0e0e0"/>
<rect width="480" height="25" rx="8" fill="#e8f5e9"/>
<text x="240" y="17" text-anchor="middle" class="heap-header">Heap (Ring Buffer)</text>
<g transform="translate(20, 60)">
<rect x="0" y="0" width="45" height="45" rx="4" fill="#fff8e1" stroke="#ff9800" stroke-width="2"/><text x="22.5" y="27" text-anchor="middle" font-family="JetBrains Mono" font-size="14" font-weight="bold" fill="#f57c00">A</text><text x="22.5" y="60" text-anchor="middle" class="index">[0]</text>
<rect x="55" y="0" width="45" height="45" rx="4" fill="#fff8e1" stroke="#ff9800" stroke-width="2"/><text x="77.5" y="27" text-anchor="middle" font-family="JetBrains Mono" font-size="14" font-weight="bold" fill="#f57c00">B</text><text x="77.5" y="60" text-anchor="middle" class="index">[1]</text>
<rect x="110" y="0" width="45" height="45" rx="4" fill="#e3f2fd" stroke="#1565c0" stroke-width="2"/><text x="132.5" y="27" text-anchor="middle" font-family="JetBrains Mono" font-size="14" font-weight="bold" fill="#1565c0">C</text><text x="132.5" y="60" text-anchor="middle" class="index">[2]</text>
<rect x="165" y="0" width="45" height="45" rx="4" fill="#e3f2fd" stroke="#1565c0" stroke-width="2"/><text x="187.5" y="27" text-anchor="middle" font-family="JetBrains Mono" font-size="14" font-weight="bold" fill="#1565c0">D</text><text x="187.5" y="60" text-anchor="middle" class="index">[3]</text>
<rect x="220" y="0" width="45" height="45" rx="4" fill="#ffffff" stroke="#e0e0e0" stroke-dasharray="3 2"/><text x="242.5" y="60" text-anchor="middle" class="index">[4]</text>
<rect x="275" y="0" width="45" height="45" rx="4" fill="#ffffff" stroke="#e0e0e0" stroke-dasharray="3 2"/><text x="297.5" y="60" text-anchor="middle" class="index">[5]</text>
<rect x="330" y="0" width="45" height="45" rx="4" fill="#ffffff" stroke="#e0e0e0" stroke-dasharray="3 2"/><text x="352.5" y="60" text-anchor="middle" class="index">[6]</text>
<rect x="385" y="0" width="45" height="45" rx="4" fill="#ffffff" stroke="#e0e0e0" stroke-dasharray="3 2"/><text x="407.5" y="60" text-anchor="middle" class="index">[7]</text>
<path d="M22.5 95 V65" stroke="#1565c0" stroke-width="1.5" marker-end="url(#arrowhead-head)"/>
<text x="22.5" y="105" text-anchor="middle" class="head-label">head</text>
<path d="M242.5 95 V65" stroke="#f57c00" stroke-width="1.5" stroke-dasharray="3 2" marker-end="url(#arrowhead-ptr)"/>
<text x="242.5" y="105" text-anchor="middle" class="ptr-label">logical back</text>
</g>
</g>
</g>
</svg>